---
title: "LMMCov: Analysis Report"
author: " "
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document: default
  pdf_document: default
  word_document: default
params:
  glm_summary: NULL
  glm_residuals: NULL
  glm_acf: NULL
  aic_plot: NULL
  lmm_summary: NULL
  aic_table: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE
)
library(DT)
library(webshot2)
library(pagedown)
library(plotly)
library(knitr)
library(kableExtra)
```

This is a dynamic report automatically generated by the LMMCov app (<https://percysavieri.shinyapps.io/LMMCov/>). It consists of sections that include the generalised linear model (GLM) model, a summary of the covariance analysis and the fitted linear mixed model (LMM) model.

### GLM Analysis

#### Model Summary

\hfill\break

The table below provides a summary of the GLM model, showing the estimated coefficients, and p-values. \hfill\break

```{r echo = FALSE, comment = NA}
params$glm_summary
```

\newpage

### Covariance Analysis

Details on the covariance structure depicted by the residuals from the GLM model and how they impact the model fit and interpretation. 
\hfill\break

#### Residual plot from the GLM based on the correlation matrix 
\hfill\break 

The residual plot helps in identifying the underlying correlation structure in the repeated measures. 

```{r echo = FALSE, comment = NA}
p1 <- params$glm_residuals

if (knitr::is_html_output()) {
  # Render Plotly plot for HTML output
  p1
} else {
  # Save Plotly plot as an image for PDF/Word output
  saveWidget(p1, "glm_residuals.html", selfcontained = TRUE)
  webshot("glm_residuals.html", "glm_residuals.png", zoom = 0.75)
  knitr::include_graphics("glm_residuals.png")
}
```

\newpage

#### Partial Autocorrelation function (PACF) plot from GLM model

\hfill\break

The PACF plot shows the correlation of the residuals with themselves over different time lags. This helps in identifying any patterns or correlations that exist in the residuals.

```{r echo = FALSE, comment = NA}
p2 <- params$glm_acf

if (knitr::is_html_output()) {
  # Render Plotly plot for HTML output
  p2
} else {
  # Save Plotly plot as an image for PDF/Word output
  saveWidget(p2, "glm_acf.html", selfcontained = TRUE)
  webshot("glm_acf.html", "glm_acf.png", zoom = 0.75)
  knitr::include_graphics("glm_acf.png")
}
```

\newpage

#### Auto-regressive model comparison plot

\hfill\break

This plot compares their AIC (Akaike Information Criterion) values if multiple auto-regressive models were fitted. Lower AIC values indicate a better fit. 

```{r echo = FALSE, comment = NA}
p3 <- params$aic_plot

if (knitr::is_html_output()) {
  # Render Plotly plot for HTML output
  p3
} else {
  # Save Plotly plot as an image for PDF/Word output
  saveWidget(p3, "aic_plot.html", selfcontained = TRUE)
  webshot("aic_plot.html", "aic_plot.png", zoom = 0.75)
  knitr::include_graphics("aic_plot.png")
}
```

\newpage

### LMM Analysis

#### Model summary

\hfill\break

The table below summarises the LMM with the selected covariance structure. \hfill\break

```{r echo = FALSE, comment = NA}
params$lmm_summary
```

\newpage

#### Model comparison using AIC

\hfill\break

The table below compares the AIC values for different models fitted with random effects and the covariance structure. This identifies which model best fits the data while accounting for complexity. 

```{r echo = FALSE, comment = NA}
#params$aic_table
#params$aic_table
if (knitr::is_html_output()) {
  # Render DT table for HTML output
  DT::datatable(params$aic_table, options = list(dom = 't', paging = FALSE), style = 'bootstrap', class = 'table table-striped table-bordered', rownames = FALSE) %>%
    DT::formatStyle(columns = 1:ncol(params$aic_table), `text-align` = 'left')
} else {
  # Render table with kable for PDF/Word output
  knitr::kable(params$aic_table, format = "latex", booktabs = TRUE, longtable = TRUE) %>%
    kableExtra::kable_styling(latex_options = c("hold_position", "striped"))
}
```
